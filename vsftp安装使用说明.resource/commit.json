{"compress":true,"commitItems":[["33a205c9-5fa3-4d3e-b349-902e98b5b1ee",1536909179655,"# vsftpd安装使用说明\n\n`vsftpd`是在`linux`环境下，使用最多的`FTP`服务端软件。\n\n`vsftpd`默认只能使用root用户运行。使用非`root`用户运行，需要在配置文件里设置`run_as_launching_user=YES`。\n\n**官方强烈不推荐使用这种方式启动，会带来巨大的安全问题，并且会导致无法使用`chroot`技术来限制文件访问。**\n\n以下安装配置均在`root`账号下进行。\n\n## 安装\n\n```bash\nyum install -y vsftpd\nyum install -y db4 #设置虚拟账户的本地数据库文件用\n```\n\n也可以下载源码安装，解压之后直接`make & make install`即可安装。  \n不提供`configure`文件，所以无法指定路径。\n\n安装完成后会在相关目录生成文件，需要用到的如下：\n\n```bash\n/usr/sbin/vsftpd #vsftpd可执行文件\n\n/etc/vsftpd/vsftpd.conf #主配置文件\n\n/etc/pam.d/vsftpd #PAM认证文件\n\n/etc/vsftpd.ftpusers #禁用使用VSFTPD的用户列表文件\n\n/etc/vsftpd.user_list #禁止或允许使用VSFTPD的用户列表文件\n```\n\n## 配置\n\n### vsftpd主要配置\n\n先对默认配置文件进行备份，再进行配置。\n\n```bash\ncp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.bak\n```\n\n配置文件具体配置如下：\n\n```bash\nanonymous_enable=NO #不允许匿名登录\nlocal_enable=YES\nwrite_enable=YES\nlocal_umask=022  #上传文件权限补码，最终上传后的文件权限为  666-022=644\ndirmessage_enable=YES\nxferlog_enable=YES\nconnect_from_port_20=YES\nxferlog_std_format=YES\nascii_upload_enable=YES\nascii_download_enable=YES\nchroot_local_user=NO #虚拟账户配置下，在下面两个chroot配置后，这个参数必须为NO，否则登陆FTP后还可以访问其他目录！\nchroot_list_enable=YES \nallow_writeable_chroot=YES\nchroot_list_file=/home/ftp/config/chroot_list #指定不能离开家目录的用户列表文件，一行一个用户。使用此方法时必须chroot_local_user=NO。说明这个列表里面的用户登陆ftp后都只能访问其主目录，其他目录都不能访问！\nlisten=YES #监听IPV4\nlisten_ipv6=NO #监听IPV6，不能和上面的listen同时设置为YES\n\npam_service_name=vsftpd #指定PAM配置文件，即下面的/etc/pam.d/vsftpd文件要和这里指定的一致\nuserlist_enable=YES\ntcp_wrappers=YES\n\nvirtual_use_local_privs=YES\nguest_enable=YES #启用虚拟账户\nguest_username=chenxj #将虚拟用户映射为本地chenxj用户（前提是local_enable=YES），更安全的做法是映射为nobody用户，因为nobody的权限最低\n\nuser_config_dir=/home/ftp/config/vuser_conf #指定不同虚拟用户配置文件的存放路径\n\nlisten_port=21 #监听的ftp端口，改成其他端口，会导致无法启动\npasv_min_port=40001 #分配给ftp账号的最小端口。被动模式下的配置\npasv_max_port=40100 #分配给ftp账号的最大端口。每个账号分配一个端口，即最大允许100个ftp账号连接\nmax_clients=150 #客户端的最大连接数\naccept_timeout=5\nconnect_timeout=1\nmax_per_ip=5 #每个ip最大连接数\n```\n\n**以上配置有修改，需要重启vsftpd服务才能生效**。\n\n### 虚拟账户设置\n\n在自己决定的目录（如：`/home/ftp/config`）新建`vuser_passwd.txt`，奇数行为账号，偶数行为密码:\n\n```bash\nuser1  #账号1\nuser1@2018 #账号1密码\nuser2 #账号2\nuser2@2018 #账号2密码\n```\n\n在此目录下，生成虚拟用户口令认证的db文件，这是本地数据库文件：\n\n```bash\ncd /home/ftp/config\ndb_load -T -t hash -f vuser_passwd.txt vuser_passwd.db\nchmod 600 vuser_passwd.db #安全起见，将该文件的权限设置为root读写\n```\n\n同时在该目录下，新建`chroot_list`文件，即`/etc/vsftpd/vsftpd.conf`中的`chroot_list_file=`，并将虚拟账户的账号放在这个文件中。\n\n```bash\ncat chroot_list\nuser1\nuser2\n```\n\n然后新建`vuser_conf`目录，即`/etc/vsftpd/vsftpd.conf`中的`user_config_dir=`。用于存放每个虚拟账户的配置文件，虚拟账户的配置文件以虚拟账户的用户名命名。\n\n```bash\nmkdir vuser_conf\nvim user1\n# 配置如下：\nlocal_root=/home/ftp/data/user1 #目录需已经存在，拥有者需为/etc/vsftpd/vsftpd.conf 中guest_username指定的用户\nwrite_enable=YES\nanon_umask=022\nanon_world_readable_only=NO\nanon_upload_enable=YES\nanon_mkdir_write_enable=YES\nanon_other_write_enable=YES\n```\n\n**以上配置有修改，不需要重启vsftpd，即时生效**。\n\n### PAM认证\n\n修改`/etc/pam.d/vsftpd`文件，注释掉原来的内容，在最后两行添加认证文件路径，如下所示：\n\n```bash\n#%PAM-1.0\n#session    optional     pam_keyinit.so    force revoke\n#auth       required\tpam_listfile.so item=user sense=deny file=/etc/vsftpd/ftpusers onerr=succeed\n#auth       required\tpam_shells.so\n#auth       include\tpassword-auth\n#account    include\tpassword-auth\n#session    required     pam_loginuid.so\n#session    include\tpassword-auth\nauth\trequired\t/lib64/security/pam_userdb.so\tdb=/home/ftp/config/vuser_passwd\naccount required\t/lib64/security/pam_userdb.so db=/home/ftp/config/vuser_passwd\n```\n\n中间使用`Tab`键分隔。\n\n## 启动\n\n```bash\nsystemctl start vsftpd #启动\nsystemctl restart vsftpd #重启\nsystemctl stop vsftpd #停止\nsystemctl status vsftpd #查看状态\n```\n\n## 管理\n\n写了`3`个小脚本来管理。\n\n### 新增用户\n\n```bash\nsh /home/ftp/script/setFTP.sh <user> <passwd> <path>\n```\n\n代码如下：\n\n```bash\n#!/bin/sh\n\nuser=$1\npasswd=$2\npath=$3\n\necho $user >> /home/ftp/config/chroot_list\necho -e \"$user\\n$passwd\" >> /home/ftp/config/vuser_passwd.txt\ndb_load -T -t hash -f /home/ftp/config/vuser_passwd.txt /home/ftp/config/vuser_passwd.db\n\nmkdir $path\nchown -R chenxj:chenxj $path\nchmod 700 $path\n\necho -e \"local_root=$path\\nwrite_enable=YES\\nanon_world_readable_only=NO\\nanon_upload_enable=YES\\nanon_mkdir_write_enable=YES\\nanon_other_write_enable=YES\" > /home/ftp/config/vuser_conf/$user\n```\n\n### 取消和恢复\n\n如果希望某个路径关闭FTP，则直接修改其权限为`600`即可，则在配置文件中`local_root`指定为该路径的账号全都无法登陆。同理，恢复则将权限修改为`700`：\n\n```bash\nsh /home/ftp/script/cancelFTP.sh <path> #chmod 600 $path\nsh /home/ftp/script/recoverFTP.sh <path> #chmod 700 $path\n```\n",[[1536909168294,["Administrator@SJEZTQE6O5WNT6L",[[1,219,"===="]],[219,219],[221,221]]]],null,"Administrator@SJEZTQE6O5WNT6L"]]}